SELECT
	LEFT(A.Supplier_Code,5) AS Supplier_Code,
	A.Supplier_Name,
	A.Site_Code,
	TPNB,
	Spec_Status
	Specification_Number,
	Specification_Type,
	Site_Name,
	Audit,
	Last_Audit_Date,
	Last_Audit_Score,
	Score,
	Due_Date,
	From_Date,
	To_Date,
	Audit_Visit_Id,
	Audit_Visit_Status,
	Site_Status,
	Lead_Technical_Manager,
	Business_Units,
	Country,
	Path,
	Tesco_Brand_Ind,
	Junior_Buyer,
	Buyer,
	Buying_Controller,
	Category_Director,
	Commercial_Director,
	Product_Sub_Group_Code,
	Long_Description
FROM (SELECT DISTINCT CONCAT(Site_Code,LEFT(Supplier_Code,5)) AS SS_Code,X.* FROM [tblAudits] AS X
	 --	WHERE left(Audit,5) LIKE '%Audit%'
	  --WHERE Business_Units='United Kingdom'
	  /*AND Audit IN ('Audit: Tesco Food Standard',
					'Audit: Tesco Non Food Standard',
					'Audit: Tesco Food Manufacturing Standard V4.0',
					'Audit: TFMS - Maintenance V6',
					'Audit: TFMS - Approval V6',
					'Audit: TTFMS - Maintenance V5.1',
					'Audit: TTFMS - Approval V5.1',
					'Audit: TNFMS - Maintenance V3',
					'Audit: TNFMS - Approval V3')*/
	  ) AS A
LEFT JOIN
	(SELECT DISTINCT 
			CONCAT(Site_Code,Supplier_Code) AS SS_Code,
			TPNB,
			St as Spec_Status,
			Specification_Number,
			Specification_Type,
			Site_Code,
			Supplier_Code,
			Tesco_Brand_Ind,
			Junior_Buyer,
			Buyer,
			Buying_Controller,
			Category_Director,
			Commercial_Director,
			TEMP.Product_Sub_Group_Code,
			TEMP.Long_Description 
			FROM (
						SELECT DISTINCT TPNB,
										Site_Code,
										Supplier_Code,
										Specification_Number,
										Specification_Type,
										Status as St
										FROM 
										[tblSpecTpnbs]
										where TPNB in (71901266,
71916053,
71916076,
50155823,
50392956,
50392979,
50966111,
51321809,
51628833,
51723933,
54672193,
56439277,
57462696,
57462707,
57462713,
57462736,
66662136,
70520954,
70521066,
70521187,
70583838,
71158834,
71645730,
73227329,
73227905,
73228000,
75811487,
75947654,
75947666,
75948279,
76090006,
76099434,
77379131,
77379148,
78228430,
78228499,
78228580,
78228931,
78229233,
79720409,
79720421,
80643557,
80643626,
80643920,
80644012,
80691672,
82290550,
82340774,
82351755,
82351761,
82351778,
82351784,
82351801,
84435642,
84435665,
84435671,
84435688,
84435694,
84435734,
84435740,
84435772,
84435786,
84477119,
85135811,
85135828,
85135834,
85135840,
85135857,
85135863,
85135872,
85135886,
85135892,
85135961,
85135978,
85135984,
85136009,
85136015,
86278248,
86278254,
86278277,
86278283,
86278292,
86346082,
86346099,
86360663,
86360672,
86360686,
86360801,
86360818,
87693215,
87694024,
87738878,
87739860,
87740483,
85994415,
50312724,
50312730,
53364876,
78237776,
84435622,
85135903,
85135912,
85135926,
85135949,
85135955,
60833674,
63337957,
67791924,
70815698,
73758392,
77641327,
78939579,
78939654,
78939660,
78939683,
81318826,
81318918,
81318947,
81318982,
82150486,
82401599,
82450246,
82450315,
82873172,
82873189,
82892857,
82892892,
82892912,
82892932,
83999632,
83999655,
83999730,
84020862,
84020879,
84020891,
84021014,
84021354,
84035228,
84035303,
84035349,
84139002,
85750635,
85981091,
86000710,
86018465,
86807240,
86807272,
87385494,
87181775,
53398692,
58670678,
60596084,
60596245,
74568344,
79079068,
84730799,
84730816,
84730822,
84730839,
84730845,
84730851,
84730868,
84730874,
84742439,
84742445,
84742451,
84793539,
84793545,
84793551,
86582671,
87175881,
87228134,
56981098,
57256898,
84730655,
84730661,
84792342,
85871935,
86696882,
83003487,
83003504,
83003527,
50322741,
59370283,
62426976,
71426794,
74567881,
74567921,
74802367,
84730678,
84730684,
84730880,
84730908,
84730914,
84730920,
84730937,
84730943,
84730952,
84793447,
84793453,
84793462,
86000140,
86014694,
86582665,
86582688,
87797761,
70707089,
70707129,
70707233,
70707256,
77335955,
77335984,
78472116,
78472122,
78472139,
78472145,
81441368,
81441452,
51630098,
75865457,
75865526,
75865912,
76016649,
76983183,
78472617,
79790918,
79790953,
79790964,
80745532,
80745736,
80745765,
81609131,
82324892,
82608741,
82608758,
83531201,
84366936,
84366942,
84366959,
87182852,
87542838,
87584857,
87588064,
87588381,
50249943,
78228418,
85135990,
56925638,
82669950,
84619673,
84619682,
84961335,
83576418,
83576424,
64693763,
75149614,
75149689,
77630634,
77639210,
78525487,
78525504,
78525510,
78525556,
79718471,
79718534,
81576214,
81576341,
81796282,
84525334,
84525340,
84604682,
84604713,
84840778,
84840790,
85149956,
50349992,
50475444,
51510436,
51510442,
52925658,
52927308,
52929928,
55183885,
55183925,
57815055,
62974025,
63527387,
63527456,
63875481,
64129880,
67571465,
67571488,
68138196,
71248486,
71394876,
71875774,
72275820,
72359261,
72367821,
77491613,
77881394,
77881428,
80456082,
80456681,
81219569,
81262672,
81782183,
81782192,
81782200,
81782217,
81782232,
83176532,
83176546,
83176552,
83176569,
83176575,
83176581,
83809902,
83810009,
83810015,
84676448,
84676460,
84810359,
84810365,
84810371,
84810388,
84828828,
85088866,
85137481,
85624699,
85834404,
85834410,
85834427,
86489183,
86505240,
84730802,
85972992,
86696899,
78239561,
86689107,
79268870,
79268893,
79268904,
79268927,
80446330,
80446422,
82108083,
82108100,
82108146,
82108169,
85201932,
85202248,
85202323,
85204125,
85204154,
85204275,
85204382,
85212651,
85212766,
85212893,
85212962,
85213114,
85213152,
85242874,
85242908,
85242937,
85242966,
85243003,
85822332,
85822384,
85822430,
85822453,
86418591,
86858639,
86858680,
86858708,
86858737,
86858752,
86858772,
86858795,
86858806,
86859327,
86859362,
86859391,
86859425,
86859431,
86859448,
86859460,
86859483,
86859615,
86859644,
86859696,
86859736,
86859765,
86859794,
86859828,
86859857,
67440413)
					) AS A
		INNER JOIN
			(SELECT * FROM tblbprList
			 WHERE Product_Sub_Group_Code
			 IN (SELECT Product_Sub_Group_Code FROM [tblCategoryList]
				 WHERE Commercial_Director  IN ('FRES          H.','PACKAGE       D.') and Category_Director='PREPARED FOOD S.')
			) AS TEMP
		on A.TPNB=TEMP.Base_Product_Number
		INNER JOIN [tblCategoryList] AS C
		ON TEMP.Product_Sub_Group_Code=C.Product_Sub_Group_Code
		WHERE Site_Code IS NOT NULL AND Supplier_Code IS NOT NULL
	) AS TEMP
ON A.SS_Code=TEMP.SS_Code
WHERE Junior_Buyer IS NOT NULL AND A.Supplier_Code IS NOT NULL;

--select top 10 *  from tblbprList
------------------------------------------------------
select * from (
SELECT DISTINCT 
										row_number() over ( partition by TPNB order by Status,Year_Period desc ) as rank_col,
										Year_Period,
										TPNB,
										
										
										Status as St
										FROM 
										[tblSpecTpnbs]
										where Year_Period is not null ) as a
where a.rank_col=1